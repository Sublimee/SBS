**Пример "Подтверждение выбора категорий повышенного кэшбэка для заданного периода"**

**Логический дизайн**

1. Создание операции аудита. Если при создании операции аудита возникла ошибка, то требуется отправить пользователю сообщение о невозможности подтверждения категорий.

2. Проверка условий, которые являются пререквизитом для подтверждения категорий повышенного кэшбэка:

   1) пользователю доступна программа "Категорийный кэшбэк" в указанном периоде;
   2) пользователь еще не выбирал категории в указанном периоде;
   3) количество выбранных пользователем категорий совпадает с необходимым для выбора количеством.

   Если при проверке условий возникла ошибка или какое-либо условие не удовлетворено, то требуется:

   1) перевести операцию аудита в статус "Ошибка валидации";
   2) ответить пользователю сообщением о невозможности подтверждения категорий.
   
3. Перевод операции аудита в статус "В процессе". Если при обновлении статуса операции аудита возникла ошибка, то требуется:

   1) перевести операцию аудита в статус "Ошибка";
   2) ответить пользователю сообщением о невозможности подтверждения категорий.

4. Перевод операции аудита в статус "Успех". Если при обновлении статуса операции аудита возникла ошибка, то требуется:

   1) перевести операцию аудита в статус "Ошибка";
   2) ответить пользователю сообщением о невозможности подтверждения категорий.

5. Подтверждение категорий. Если при подтверждении возникла ошибка, то требуется:

   1) перевести операцию аудита в статус "Ошибка";
   2) ответить пользователю сообщением о невозможности подтверждения категорий.

**Соответствие кода логическому дизайну**

Код логическому дизайну не соответствует:
   1) ошибки при создании и обновлении статуса операции аудита игнорируются
   2) при ошибках валидации операция аудита переводится в статус "Ошибка", а не "Ошибка валидации"
   3) подтверждение категорий происходит перед переводом операции аудита в статус "Успех"
   4) проверка условий в коде реализована близко к логическому дизайну, но может быть уточнена

Анализируемый код в принципе делал не то что нужно: для операции подтверждения не всегда создавалась операция аудита, а если и создавалась, то проходила не по тем статусам конечного автомата. Это было следствием плохо проведенного аналитиком анализа требований. Так как прохождение операции аудита по статусам в конечном автомате не валидируется, то такая реализация работала.   

В соответствие с проведенным анализом код был переписан, благодаря чему:
1) удалось достичь соответствия кода 1:1 с дизайном
2) удалось достичь бОльшей ясности и выразительности кода