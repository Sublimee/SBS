# Пример 1

На одном из реактивных гейтвеев, который достался нам недавно по наследству, в логе у сообщений иногда проставлялись некорректные пользователь и trace ID. Так как мы используем собственную библиотеку логирования, то первое мое предположение заключалось в том, что есть ошибка в нашей библиотеке логирования. Само по себе такое предположение достаточно общее (не узкое), но я зациклился на этой идее и потерял много времени на поиск ошибки там, где ее не было. 

Что надо было сделать? Сперва -- задать себе вопрос: "Что может быть причиной ошибок при логировании?", и дать на него ответ:
1) собственно ошибка в библиотеке логирования;
2) неправильная работа с ландшафтом логирования на уровне пользовательского кода.

После консультации с коллегами, мы нашли в приложении участок кода, где правится контекст запроса. Таким образом делаем вывод, что широкие вопросы могут не только сужать область поиска, но и расширять ее новыми, ранее не рассматриваемыми, но очень вероятными гипотезами.

# Пример 2

Наша система достаточно сложна, в том числе потому, что в ней есть множество зависимостей. Множество различных проблем могут отражаться для пользователей совершенно одинаково или быть внешне похожими. Часто даже функциональное сопровождение прода не может кластеризовать несвязанные проблемы. В результате на команду заводятся баги, которые наполняются несвязанными друг с другом инцидентами, но схожими по описанию проблемы у клиентов. Когда к такому багу привязаны десятки, а то и сотни инцидентов, то ни у кого уже нет сомнения, что какая-то неустраненная проблема, действительно, есть. 

Так в истории операций у некоторых пользователей не отображался кэшбэк. Я вместе с системным аналитиком принялся последовательно разбирать каждый привязанный инцидент. В одном из кейсов мне показалось, что мы неправильно используем кэш при работе со страницами, прихранивая кэшбэк только для первой страницы, а затем отдавая одни и те же записи кэшбэка для всех страниц операций. В таком случае их привязка к операциям по понятным причинам не могла быть проведена. Я углубился в кодовую базу сервиса. В процессе кластеризации коллега-аналитик задал правильный общий вопрос: "А есть ли связь между этими инцидентами?" Оказалось, что часть инцидентов была связана с тем, что пользователь не туда посмотрел, часть -- с тем, что пользователь не понял, как начисляется кэшбэк в отдельно взятом случае, часть -- с тем, что была недоступна бэк-система. После того как я разобрался, что ошибки в кодовой базе нет, было принято решение обсудить с ФС этот баг. Мы привели аргументы, что все инциденты не связаны и постоянной проблемы нет. Баг был закрыт. ТАким образом один общий вопрос закрыл все гипотезы за исключением той, которую я проверял.

# Пример 3

На прошлой неделе у специалиста НТ не получилось достучаться до вновь развернутого приложения на новом стенде НТ. Запросы на ранее развернутые сервисы приходили. Были выдвинуты две широкие гипотезы:

1) неправильно сконфигурированы ресурсы k8s
2) неправильно задан запрос

Мы достаточно быстро отсмотрели основные ресурсы k8s и не нашли там проблем. В рамках рассмотрения второй гипотезы мы посмотрели логи, какие отправляются запросы, но там тоже не нашли ничего подозрительного. 

Так как запросы отправляются не просто с помощью curl, когда все составляющие запроса как на ладони, а с помощью специализированного софта, то велика вероятность, что он может быть сконфигурирован неправильно. Нужно было задать специалисту НТ вопрос: "Что может влиять на исполнение запроса на стороне утилиты?". После этого вопроса нужно было просто сравнить конфигурацию работающего и неработающего запросов, или поставить адрес нового сервиса -- в старый запрос, или -- наоборот.

Проблема (неправильной конфигурации), конечно, была найдена и так, но предыдущие идеи решения были точечными, на их проверку ушло много времени, но они все были неверны. На решение проблемы ушло достаточно много времени.

# Вывод

Мы в очередной раз возвращаемся к идее рассмотрения задачи/проблемы сначала на уровне аналитики/дизайна. Не следует торопиться решать проблему, спускаясь сразу на уровень реализации (проверки конкретных гипотез). Сложность крупных программных и аппаратных систем очень велика, все точечные гипотезы не проверишь.

Мне видится такой алгоритм проведения отладки:

1) задаем широкие вопросы для того, чтобы определить все (насколько это возможно) зависимости проблемы. Это позволит нам очертить круг возможных гипотез или хотя бы направлений поиска;

2) одновременно с первым собираем фактуру по проблеме. Собираем то, что можно найти быстро и позволит отвечать на задаваемые позже общие вопросы. Здесь следует соблюдать баланс между затраченным временем и глубиной поиска;

3) далее задаем себе общие вопросы. При ответе используем собранную фактуру. Общие вопросы позволят оптом расправляться с рядом нежизнеспособных на данный момент гипотез;

4) если гипотез осталось мало или их проверка может выступать в роли общего вопроса или элемента собранной фактуры, то проверяем конкретные гипотезы;

5) если в результате выполнения пункта 4 найти проблему не удалось, то стоит повторить алгоритм, вернувшись к пункту 1, чтобы убедиться, что мы не упускаем ничего из виду.

Именно поэтому на разбор крупных аварий зовут компетентных специалистов из разных направлений. Это позволяет сначала сформировать полный набор гипотез, а затем отсекать часть из них с помощью широких вопросов и накопленной фактуры. То же применимо и при разборе локальных проблем, только круг лиц и объем рассматриваемых зависимостей будет гораздо меньше.